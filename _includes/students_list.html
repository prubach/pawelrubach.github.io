<section id="thesis">
<h1>My Students' Diploma Thesis</h1>

<div style="margin-bottom:1rem;">
  <label style="font-size:1.1em;font-weight:bold;">Filter by year:</label>
  <select id="yearFilter">
    <option value="all">All years</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Filter by category:</label>
  <select id="categoryFilter">
    <option value="all">All categories</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Filter by lang:</label>
  <select id="languageFilter">
    <option value="all">All</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Filter by lab:</label>
  <select id="labFilter">
    <option value="all">All</option>
  </select>

  <label style="font-size:1.1em;font-weight:bold; margin-left:1rem;">Search:</label>
  <input type="text" id="searchBox" placeholder="Type student name or title" style="padding:0.2rem 0.5rem;">
</div>

<div id="thesis-list"></div>

<hr>

<h2>Thesis Count Per Year</h2>
<div id="yearChart" style="height:400px;"></div>

<script>
const all_theses = {{ site.data.students | jsonify }};
let theses = all_theses
    .filter(t => t.year && t.year !== "null")       // hide null or missing year
    .sort((a, b) => Number(b.year) - Number(a.year)); // newest â†’ oldest

const collaborators = {{ site.data.students_collaboration | jsonify }};
const collaboratorMap = {};
collaborators.forEach(c => {
    collaboratorMap[c.author] = { lab: c.lab, url: c.url };
});

const thesisList = document.getElementById("thesis-list");
const yearFilter = document.getElementById("yearFilter");
const categoryFilter = document.getElementById("categoryFilter");
const searchBox = document.getElementById("searchBox");

// Populate year filter
const years = [...new Set(theses.map(t => t.year))].sort().reverse();
years.forEach(y => {
  const opt = document.createElement("option");
  opt.value = y;
  opt.innerText = y;
  yearFilter.appendChild(opt);
});

// Populate category filter
const categories = [...new Set(theses.map(t => t.category))].sort();
categories.forEach(c => {
  const opt = document.createElement("option");
  opt.value = c;
  opt.innerText = c.charAt(0).toUpperCase() + c.slice(1);
  categoryFilter.appendChild(opt);
});

const languageFilter = document.getElementById("languageFilter");
const labFilter = document.getElementById("labFilter");

// Languages
const languages = [...new Set(theses.map(t => t.lang))].sort();
languages.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l;
    opt.innerText = l;
    languageFilter.appendChild(opt);
});

// Labs
const labs = [...new Set(theses.map(t => collaboratorMap[t.author] ? collaboratorMap[t.author].lab : null))].filter(Boolean).sort();
labs.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l;
    opt.innerText = l;
    labFilter.appendChild(opt);
});

function renderTheses(list) {
    thesisList.innerHTML = `
        <div class="thesis-table-header thesis-row">
            <div class="col-year">Year</div>
            <div class="col-author">Author</div>
            <div class="col-category">Type</div>
            <div class="col-lang">Lang</div>
            <div class="col-lab">Lab</div>
            <div class="col-title">Title</div>
        </div>
    `;

    list.forEach(t => {
        const item = document.createElement("div");
        item.className = "thesis-row";

        const langFlag = t.lang === "EN" ? "ðŸ‡¬ðŸ‡§" : "ðŸ‡µðŸ‡±";

        let labHTML = '';
        if (collaboratorMap[t.author]) {
            const lab = collaboratorMap[t.author];
            labHTML = `<a href="${lab.url}" target="_blank">
                           <img src="/assets/images/labs/${lab.lab}.png" alt="${lab.lab} logo" class="lab-logo">
                       </a>`;
        }

        /*<div class="col-lang">${langFlag}</div>*/
        item.innerHTML = `
            <div class="col-year">${t.year}</div>
            <div class="col-author">${t.author ?? "Unknown"}</div>
            <div class="col-category">${t.category}</div>

            <div class="col-lang">${langFlag}</div>
            <div class="col-lab">${labHTML}</div>
            <div class="col-title">
                <a href="${t.url}" target="_blank">${t.title}</a>
            </div>
        `;

        thesisList.appendChild(item);
    });
}



function renderList() {
  const selectedYear = yearFilter.value;
  const selectedCategory = categoryFilter.value;
  const selectedLang = languageFilter.value;
  const selectedLab = labFilter.value;
  const searchText = searchBox.value.toLowerCase().trim();

  let filtered = theses;

  if (selectedYear !== "all") {
    filtered = filtered.filter(t => t.year === selectedYear);
  }
  if (selectedCategory !== "all") {
    filtered = filtered.filter(t => t.category === selectedCategory);
  }
  if (selectedLang !== "all") {
    filtered = filtered.filter(t => t.language === selectedLang);
  }
  if (selectedLab !== "all") {
    filtered = filtered.filter(t => collaboratorMap[t.author] && collaboratorMap[t.author].lab === selectedLab);
  }
  if (searchText) {
    filtered = filtered.filter(t =>
      t.author.toLowerCase().includes(searchText) ||
      t.title.toLowerCase().includes(searchText)
    );
  }

  renderTheses(filtered);
  renderChart(filtered);
}


// Render chart: separate bars for Master/Bachelor
function renderChart(filtered) {
  const counts = {};
  filtered.forEach(t => {
    if (!counts[t.year]) counts[t.year] = { master: 0, bachelor: 0 };
    if (t.category === "master") counts[t.year].master += 1;
    if (t.category === "bachelor") counts[t.year].bachelor += 1;
  });

  const yearsSorted = Object.keys(counts).sort();
  const masterValues = yearsSorted.map(y => counts[y].master || 0);
  const bachelorValues = yearsSorted.map(y => counts[y].bachelor || 0);

  const data = [
    { x: yearsSorted, y: masterValues, type: 'bar', name: 'Master', marker: { color: '#1f77b4' } },
    { x: yearsSorted, y: bachelorValues, type: 'bar', name: 'Bachelor', marker: { color: '#ff7f0e' } }
  ];

  const layout = {
    title: 'Number of Theses per Year',
    xaxis: { title: 'Year' },
    yaxis: { title: 'Count' },
    barmode: 'group'
  };

  Plotly.newPlot('yearChart', data, layout);
}

// Event listeners
yearFilter.addEventListener("change", renderList);
categoryFilter.addEventListener("change", renderList);
searchBox.addEventListener("input", renderList);
languageFilter.addEventListener("change", renderList);
labFilter.addEventListener("change", renderList);

// Initial render
renderList();
</script>
</section>
